metadata:
  analysis_date: "2025-11-04"
  source: "FKB_GENRELL_DEL_5.md"
  fkb_version: "5.1"
  note: "Complete KVALITET metadata rules and SOSI format attribute specifications"

kvalitet_block:
  description: "..KVALITET metadata block - mandatory for all FKB objects"
  sosi_name: "KVALITET"
  structure: "Nested SOSI structure (3-dot level attributes)"
  datatype_name: "Posisjonskvalitet"
  definition: "Beskrivelse av kvaliteten på stedfestingen (positioning quality description)"
  note: "FKB 5.0 introduced variant where målemetode codelist replaced with more general Datafangstmetode"
  conformance: "Not fully conformant with ISO19157:2013, continuation of earlier SOSI quality properties"

  required_attributes:
    - attribute: "DATAFANGSTMETODE"
      property_name: "datafangstmetode"
      type: "T"  # Text/CodeList
      sosi_datatype: "T"
      sosi_length: 3
      multiplicity: "[1..1]"
      description: "Metode for datafangst. Describes data capture method for horizontal coordinates (x,y), or both horizontal and height (x,y,z) if datafangstmetodeHøyde not specified"
      codelist_url: "https://register.geonorge.no/sosi-kodelister/fkb/generell/5.0/datafangstmetode"
      mandatory: true
      allowed_values:
        - code: "byg"
          norwegian_name: "Som bygget"
          description: "Position from projected/planned data (e.g., BIM model) verified as-built by survey measurements"

        - code: "ukj"
          norwegian_name: "Ukjent"
          description: "Unknown or unspecified data capture method"

        - code: "pla"
          norwegian_name: "Plandata"
          description: "Position from plan data. Position not verified by survey"

        - code: "sat"
          norwegian_name: "Satellittmålt"
          description: "Position measured directly with GNSS (for positions with GNSS combined with other surveying methods, use 'lan' code)"

        - code: "gen"
          norwegian_name: "Generert"
          description: "Position manually constructed or generated by machine learning/software from point cloud (laser, photogrammetry, sonar, other sensors or combinations)"

        - code: "fot"
          norwegian_name: "Fotogrammetri"
          description: "Position constructed/generated from photogrammetric stereo model"

        - code: "dig"
          norwegian_name: "Digitalisert"
          description: "Position digitized from orthophoto or other planar map data"

        - code: "lan"
          norwegian_name: "Landmålt"
          description: "Position determined through direct surveying methods: leveling, angle measurement, distance measurement, inertial surveying, potentially combined with GNSS and adjustment calculations"

      constraint: "For photogrammetric registration, always use 'fot'"

    - attribute: "NØYAKTIGHET"
      property_name: "nøyaktighet"
      type: "H"  # Integer/Heltall
      sosi_datatype: "H"
      sosi_length: 6
      unit: "cm"
      multiplicity: "[0..1]"
      description: "Standardavviket til posisjoneringa av objektet oppgitt i cm (standard deviation of object positioning in cm)"
      detail: "In most cases, an estimated or expected standard deviation value is used, but if calculated value exists it shall be used"
      interpretation_by_geometry:
        - geometry: "PUNKT (Point)"
          interpretation: "Point standard deviation value"
        - geometry: "KURVE (Curve/Line)"
          interpretation: "Standard deviation for transverse deviation from curve"
        - geometry: "FLATE/VOLUM (Surface/Volume)"
          interpretation: "Standard deviation calculated from 3D deviations between true position and nearest point on surface"
      mandatory: false
      mandatory_for_photogrammetry: true
      note: "Value describes accuracy compared to true value. Standard deviation measures random deviation, assuming systematic deviation minimally affects positioning accuracy. For photogrammetric data, value typically set equal to standard deviation requirement for data capture"
      reference: "See Geodatakvalitet standard for detailed definition, calculation and control methods"

    - attribute: "SYNBARHET"
      property_name: "synbarhet"
      type: "H"  # Integer
      sosi_datatype: "H"
      sosi_length: 1
      multiplicity: "[0..1]"
      description: "Beskrivelse av hvor godt objektene framgår i datagrunnlaget for posisjonering (how well objects appear in positioning data source, e.g., aerial photos)"
      codelist_url: "https://register.geonorge.no/sosi-kodelister/fkb/generell/5.0/synbarhet"
      mandatory: false
      mandatory_for_photogrammetry: true
      allowed_values:
        - code: 0
          norwegian_name: "Fullt ut synlig"
          description: "Object fully visible/identifiable in aerial photos or other positioning data source"

        - code: 1
          norwegian_name: "Dårlig gjenfinnbar i terreng"
          description: "Object position difficult to define precisely in terrain due to object's nature or lack of contrast with surroundings"

        - code: 2
          norwegian_name: "Middels synlig"
          description: "Object moderately visible/recognizable in aerial photos or other positioning data source"

        - code: 3
          norwegian_name: "Ikke synlig"
          description: "Object not visible/recognizable in aerial photos or other positioning data source"

    - attribute: "DATAFANGSTMETODEHØYDE"
      property_name: "datafangstmetodeHøyde"
      type: "T"  # Text/CodeList
      sosi_datatype: "T"
      sosi_length: 3
      multiplicity: "[0..1]"
      description: "Metoden brukt for høyderegistrering av posisjon (method used for height registration)"
      detail: "Only necessary to specify if height capture method differs from horizontal capture method"
      codelist_url: "https://register.geonorge.no/sosi-kodelister/fkb/generell/5.0/datafangstmetode"
      mandatory: false
      applies_when: "Height capture method differs from DATAFANGSTMETODE"
      allowed_values: "Same codes as DATAFANGSTMETODE except 'dig'"
      constraint: "inv: self.datafangstmetodeHøyde <> 'dig' -- Datafangstmetode Digitalisert shall not be used for datafangstmetodeHøyde"

    - attribute: "H-NØYAKTIGHET"
      property_name: "nøyaktighetHøyde"
      type: "H"  # Integer
      sosi_datatype: "H"
      sosi_length: 6
      unit: "cm"
      multiplicity: "[0..1]"
      description: "Standardavviket til posisjoneringa av objektet oppgitt i cm (vertical standard deviation in cm)"
      detail: "Same interpretation as NØYAKTIGHET but for vertical component"
      mandatory: false
      applies_when: "Object has 3D geometry (height/Z coordinates)"
      note: "For photogrammetric data, value typically set equal to height standard deviation requirement for data capture"

  formatting_rules:
    - rule_id: "KVAL-FORMAT-001"
      description: "No attribute compactification in FKB 5.1 SOSI format"
      detail: "DATAFANGSTMETODE, NØYAKTIGHET, etc. must be specified as individual attributes at 3-dot level under ..KVALITET"
      applies_to: "SOSI format"
      introduced_version: "FKB 5.1"

    - rule_id: "KVAL-FORMAT-002"
      description: "KVALITET attributes at 3-dot level (nested under ..KVALITET)"
      example: |
        ..KVALITET
        ...DATAFANGSTMETODE fot
        ...NØYAKTIGHET 120
        ...SYNBARHET 0

common_metadata_attributes:
  description: "Attributes outside KVALITET block (at 2-dot level)"

  attributes:
    - attribute: "OPPDATERINGSDATO"
      property_name: "oppdateringsdato"
      type: "DATOTID"
      format: "YYYYMMDDHHMMSS"
      example: "20210929133801"
      description: "Last update timestamp - when object data was last modified"
      multiplicity: "[1..1]"
      mandatory: true
      inheritance: "Part of Fellesegenskaper (common properties)"

    - attribute: "DATAFANGSTDATO"
      property_name: "datafangstdato"
      type: "DATO"
      format: "YYYYMMDD"
      example: "20210924"
      description: "Data capture date - when object was observed/measured"
      multiplicity: "[1..1]"
      mandatory: true
      inheritance: "Part of Posisjonskvalitet (positioning quality)"
      note_photogrammetry: "Should be date when aerial photos were taken (flight date). If photos from multiple dates, can agree on single date for project"

    - attribute: "VERIFISERINGSDATO"
      property_name: "verifiseringsdato"
      type: "DATO"
      format: "YYYYMMDD"
      description: "Verification date - when confirmed that existing data object still matches reality"
      multiplicity: "[0..1]"
      mandatory: false
      use_case: "Used in photogrammetric updates where no changes registered (real object matches data object)"
      note: "LOKALID must remain unchanged when object is verified during updates"

    - attribute: "SLUTTDATO"
      property_name: "sluttdato"
      type: "DATOTID"
      format: "YYYYMMDDHHMMSS"
      description: "End date - when object ceased to exist in reality"
      multiplicity: "[0..1]"
      mandatory: false
      lifecycle_note: "Used for historical/temporal data management"

    - attribute: "LOKALID"
      property_name: "identifikasjon/lokalId"
      type: "T"  # CharacterString
      format: "UUID v4"
      example: "5e1d42bb-fd1c-4a58-92dc-aa0b3fadf57d"
      description: "Local identifier - unique identifier within namespace"
      multiplicity: "[1..1]"
      mandatory: true
      generation_rule: "UUID version 4"
      uniqueness: "Must be unique within dataset/namespace"
      sosi_nesting: "..IDENT / ...LOKALID (nested under ..IDENT group)"

    - attribute: "NAVNEROM"
      property_name: "identifikasjon/navnerom"
      type: "T"  # CharacterString
      format: "URI"
      example: "http://data.geonorge.no/SOSI/FKB-Bygning/5.0"
      description: "Namespace URI - identifies the data specification and version"
      multiplicity: "[1..1]"
      mandatory: true
      pattern: "http://data.geonorge.no/SOSI/FKB-{Dataset}/{Version}"
      sosi_nesting: "..IDENT / ...NAVNEROM (nested under ..IDENT group)"

    - attribute: "VERSJONID"
      property_name: "identifikasjon/versjonId"
      type: "T"  # CharacterString
      example: "2021-09-24 11:51:54.015000"
      description: "Version identifier - timestamp of object version"
      multiplicity: "[0..1]"
      mandatory: false
      sosi_nesting: "..IDENT / ...VERSJONID (nested under ..IDENT group)"

    - attribute: "REGISTRERINGSVERSJON"
      property_name: "registreringsversjon"
      type: "T"  # CodeList
      format: "YYYY-MM-DD"
      example: "2022-01-01"
      description: "Product specification version - FKB version used for registration"
      multiplicity: "[0..1]"
      mandatory: false
      relevance: "Most relevant for photogrammetrically registered data"
      codelist_url: "https://register.geonorge.no/sosi-kodelister/fkb/generell/5.0/registreringsversjon"

    - attribute: "INFORMASJON"
      property_name: "informasjon"
      type: "T"  # CharacterString
      example: "Dette er fiktive eksempeldata"
      description: "General information/comments about the object"
      multiplicity: "[0..1]"
      mandatory: false

    - attribute: "MEDIUM"
      property_name: "medium"
      type: "T"  # CodeList
      sosi_datatype: "T"
      sosi_length: 1
      description: "Objektets beliggenhet i forhold til jordoverflaten (object location relative to ground surface)"
      multiplicity: "[0..1]"  # Varies by object type
      mandatory: "Varies by object type"
      codelist_url: "https://register.geonorge.no/sosi-kodelister/fkb/generell/5.0/medium"
      common_values:
        - code: "T"
          name: "På terrenget"
          description: "On terrain - standard value for most objects"

        - code: "U"
          name: "Under terrenget"
          description: "Under ground - objects below surface, partially under bridges/buildings/culverts"

        - code: "B"
          name: "På bygning"
          description: "On building - objects on top of (on roof of) buildings"

        - code: "L"
          name: "I lufta"
          description: "In air - objects in air (on poles, on bridges)"

      note: "Used extensively for controlling drawing/rendering rules (e.g., U objects not drawn or dashed, L objects drawn on top)"

    - attribute: "HREF"
      sosi_name: "HREF"
      property_name: "høydereferanse"
      type: "T"  # CodeList
      sosi_datatype: "T"
      sosi_length: 6
      description: "Koordinatregistering utført på topp eller bunn av objekt (height reference: top or bottom of object)"
      multiplicity: "[0..1]"  # Varies by object type
      mandatory: "Varies by object type"
      codelist_url: "https://register.geonorge.no/sosi-kodelister/fkb/generell/5.0/hoydereferanse"
      common_values:
        - code: "topp"
          name: "Toppen av objektet"
          description: "Top of object - standard for photogrammetric registration"

        - code: "fot"
          name: "Foten av objektet"
          description: "Bottom/foot of object - used only when specified for object type or terrain height required"

sosi_header_requirements:
  description: "Required elements in SOSI .HODE (header) section"
  note: "Header at level 0 (no dots before .HODE)"

  required_elements:
    - element: ".TEGNSETT"
      value: "UTF-8"
      mandatory: true
      level: 1
      description: "Character encoding"
      note: "UTF-8 required for FKB 5.x"

    - element: ".KOORDSYS"
      format: "[system code]"
      type: "Integer"
      mandatory: true
      level: 1
      description: "Coordinate reference system"
      allowed_values:
        - code: 22
          name: "EUREF89 UTM32"
          description: "UTM zone 32 - municipalities from Trøndelag and south"

        - code: 23
          name: "EUREF89 UTM33"
          description: "UTM zone 33 - municipalities in Nordland and Troms"

        - code: 25
          name: "EUREF89 UTM35"
          description: "UTM zone 35 - municipalities in Finnmark"

      note: "SOSI code differs from EPSG code. See coordinate system mapping table"

    - element: ".VERT-DATUM"
      format: "[datum code]"
      mandatory: true
      level: 1
      description: "Vertical datum"
      allowed_values:
        - code: "NN2000"
          description: "Norwegian vertical reference system NN2000"

        - code: "NN1954"
          description: "Old Norwegian vertical reference system NN1954"

        - code: "ikke angitt"
          description: "Not specified - for 2D data without heights"

    - element: ".SOSI-VERSJON"
      value: "5.0"
      mandatory: true
      level: 1
      description: "SOSI format version"
      note: "FKB 5.1 uses SOSI format version 5.0"

    - element: ".OBJEKTKATALOG"
      format: "[catalog name and version]"
      example: "FKBBygning 5.0.1"
      mandatory: true
      level: 1
      description: "Object catalog name and version"
      pattern: "FKB{Dataset} {Version}"

  coordinate_system_mapping:
    description: "Mapping between SOSI codes and EPSG codes"
    source_table: "Table 13 - Romlige referansesystem"

    systems:
      - name: "EUREF89 UTM32 (2d)"
        epsg_code: 25832
        sosi_koordsys: 22
        sosi_vert_datum: "ikke angitt"
        url: "https://register.geonorge.no/epsg-koder/euref89-utm-sone-32-2d"

      - name: "EUREF89 UTM33 (2d)"
        epsg_code: 25833
        sosi_koordsys: 23
        sosi_vert_datum: "ikke angitt"
        url: "https://register.geonorge.no/epsg-koder/euref89-utm-sone-33-2d"

      - name: "EUREF89 UTM35 (2d)"
        epsg_code: 25835
        sosi_koordsys: 25
        sosi_vert_datum: "ikke angitt"
        url: "https://register.geonorge.no/epsg-koder/euref89-utm-sone-35-2d"

      - name: "EUREF89 UTM32 + NN2000"
        epsg_code: 5972
        sosi_koordsys: 22
        sosi_vert_datum: "NN2000"
        url: "https://register.geonorge.no/epsg-koder/euref89-utm-sone-32-2d-nn2000"

      - name: "EUREF89 UTM33 + NN2000"
        epsg_code: 5973
        sosi_koordsys: 23
        sosi_vert_datum: "NN2000"
        url: "https://register.geonorge.no/epsg-koder/euref89-utm-sone-33-2d-nn2000"

      - name: "EUREF89 UTM35 + NN2000"
        epsg_code: 5975
        sosi_koordsys: 25
        sosi_vert_datum: "NN2000"
        url: "https://register.geonorge.no/epsg-koder/euref89-utm-sone-35-2d-nn2000"

    utm_zone_assignment:
      - region: "Finnmark fylke"
        utm_zone: "UTM35"
        sosi_code: 25

      - region: "Nordland og Troms"
        utm_zone: "UTM33"
        sosi_code: 23

      - region: "Trøndelag and south"
        utm_zone: "UTM32"
        sosi_code: 22

validation_rules:
  - rule_id: "META-001"
    description: "All mandatory KVALITET attributes must be present"
    detail: "DATAFANGSTMETODE always required. NØYAKTIGHET and SYNBARHET required for photogrammetric data"
    severity: "Error"

  - rule_id: "META-002"
    description: "NØYAKTIGHET must match nøyaktighetsklasse requirements"
    detail: "Value must equal or be better than standard deviation requirement for FKB standard and accuracy class"
    reference: "See 03-ACCURACY-STANDARDS.yaml"
    severity: "Warning"

  - rule_id: "META-003"
    description: "DATAFANGSTDATO ≤ OPPDATERINGSDATO"
    detail: "Data capture date cannot be after last update date"
    severity: "Error"

  - rule_id: "META-004"
    description: "LOKALID must be unique within dataset"
    detail: "Each object must have unique UUID within its namespace"
    scope: "Within NAVNEROM"
    severity: "Error"

  - rule_id: "META-005"
    description: "H-NØYAKTIGHET required if object has Z coordinates"
    detail: "Objects with 3D geometry should specify vertical accuracy"
    applies_when: "Geometry includes height/Z values"
    severity: "Warning"

  - rule_id: "META-006"
    description: "VERIFISERINGSDATO ≤ OPPDATERINGSDATO"
    detail: "Verification date cannot be after last update"
    severity: "Error"

  - rule_id: "META-007"
    description: "DATAFANGSTMETODEHØYDE cannot be 'dig'"
    detail: "Digitized method invalid for height capture"
    constraint: "inv: self.datafangstmetodeHøyde <> 'dig'"
    severity: "Error"

  - rule_id: "META-008"
    description: "NAVNEROM must follow URI pattern"
    pattern: "http://data.geonorge.no/[S]FKB[/municipality_code]/FKB-{Dataset}[/dataset_suffix]"
    example: "http://data.geonorge.no/SOSI/FKB-Bygning/5.0"
    severity: "Error"

  - rule_id: "META-009"
    description: "REGISTRERINGSVERSJON format YYYY-MM-DD"
    pattern: "^\\d{4}-\\d{2}-\\d{2}$"
    example: "2022-01-01"
    severity: "Error"

  - rule_id: "META-010"
    description: "Coordinate system must match regional assignment"
    detail: "Municipality location determines correct UTM zone"
    reference: "See utm_zone_assignment"
    severity: "Error"

inheritance_patterns:
  description: "Common attribute inheritance from supertypes"

  supertypes:
    - supertype: "Fellesegenskaper"
      english: "Common properties"
      provides:
        - "OPPDATERINGSDATO"
        - "SLUTTDATO"
        - "DATAFANGSTDATO"
        - "VERIFISERINGSDATO"
        - "REGISTRERINGSVERSJON"
        - "INFORMASJON"
      usage: "Base type for objects without specific quality requirements"

    - supertype: "KvalitetPåkrevd"
      english: "Quality required"
      inherits_from: "Fellesegenskaper"
      provides:
        - "KVALITET (required)"
        - "All attributes from Fellesegenskaper"
      usage: "For objects requiring positioning quality metadata"

    - supertype: "KvalitetOpsjonell"
      english: "Quality optional"
      inherits_from: "Fellesegenskaper"
      provides:
        - "KVALITET (optional)"
        - "All attributes from Fellesegenskaper"
      usage: "For objects where quality metadata is optional"

photogrammetric_registration_rules:
  description: "Special rules for photogrammetric data capture"
  source_section: "Vedlegg D: Generelle retningslinjer for fotogrammetrisk registrering"

  quality_attributes:
    - rule: "Always use DATAFANGSTMETODE = 'fot'"
      mandatory: true

    - rule: "Always register NØYAKTIGHET"
      mandatory: true
      value: "Set to standard deviation requirement for accuracy class"

    - rule: "Always register SYNBARHET"
      mandatory: true
      value: "0-3 based on visibility in aerial photos"

    - rule: "DATAFANGSTDATO should be flight photo date"
      note: "If photos from multiple dates, agree on single date for project"

  attribute_compactification:
    rule: "No compactification in FKB 5.1"
    detail: "All attributes must be specified individually at 3-dot level under ..KVALITET"
    change_from_previous: "Previous versions allowed compactification"

continuous_vs_periodic_updates:
  description: "Different quality requirements for update methods"

  continuous_updates:
    method: "Administrative maintenance"
    sources: "Building permits, construction completion, partner reporting"
    priority: "Completeness and speed over positioning accuracy"
    quality_requirement: "May have lower accuracy than FKB standard requirement"
    quality_metadata: "Must still include KVALITET block with DATAFANGSTMETODE and NØYAKTIGHET"
    note: "All relevant objects must be coded with data capture method and positioning accuracy information"

  periodic_updates:
    method: "Photogrammetric or systematic updates"
    requirement: "Bring data to same level as new mapping"
    quality_requirement: "Must meet full FKB standard accuracy requirements"
    actions:
      - "Verify continuously updated data"
      - "Improve quality if needed"
      - "Add missing objects"
      - "Delete obsolete objects"
    note: "Objects unchanged from verification are not remapped"

special_geometry_rules:
  description: "Quality metadata for objects with owned (heleid) surface geometry"
  source_section: "D.1.3 Egenskaper på flater med heleid geometri"

  requirement: "Quality attributes must represent entire surface object"
  note: "Cannot split boundary and set different quality/date on different parts"

  reduced_quality_handling:
    rule: "If parts of boundary have reduced quality, must be reflected in surface quality coding"

  update_rule:
    rule: "When updating a surface, set new DATAFANGSTDATO on surface object"
